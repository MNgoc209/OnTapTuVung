<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!-- C·∫•u h√¨nh ƒë·ªÉ ch·∫°y nh∆∞ App tr√™n ƒëi·ªán tho·∫°i (PWA) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#F5AFAF">
    <meta name="format-detection" content="telephone=no">

    <title>JLPT Mastery - H·ªá Th·ªëng √în T·∫≠p Th√¥ng Minh</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            /* Palette Pastel Pink (Default - Restored) */
            --color1: #F5AFAF; /* H·ªìng ƒë·∫≠m - Primary */
            --color2: #F9DFDF; /* H·ªìng nh·∫°t - Border/Bg input */
            --color3: #FBEFEF; /* H·ªìng r·∫•t nh·∫°t - Button bg */
            --color4: #FCF8F8; /* Tr·∫Øng h·ªìng - Card bg */
            --color5: #FDEDED; /* H·ªìng s√°ng - Hover */
            --color6: #FDACAC; /* H·ªìng nh·∫•n - Gradient/Action */
            
            --success: #27ae60; --danger: #e74c3c; --ai: #8e44ad; --warning: #f39c12; --debug: #576574;
            --text: #4A4A4A; --bg: #fdf8f8;
            --lv1: #e74c3c; --lv2: #e67e22; --lv3: #f1c40f; --lv4: #2ecc71;
            --lv5: #3498db; --lv6: #9b59b6; --lv7: #1abc9c; --lv8: #2c3e50;
        }

        /* Blue Theme Override */
        body.theme-blue {
            /* Palette Ocean Blue */
            --color1: #1C4D8D; 
            --color2: #C4E1E6; 
            --color3: #D6F4ED; 
            --color4: #FFFFFF; 
            --color5: #BDE8F5; 
            --color6: #4988C4; 
            
            --text: #0F2854;   
            --bg: #F0F8FF;     
            --ai: #0F2854;     
        }

        /* Watermelon Theme Override */
        body.theme-watermelon {
            /* Palette Watermelon (D∆∞a H·∫•u) */
            --color1: #FFAAB8; /* Pink (Flesh) */
            --color2: #FFD8DF; /* Light Pink */
            --color3: #F0FFDF; /* Light Green */
            --color4: #FFFFFF;
            --color5: #E8F5E9; 
            --color6: #A8DF8E; /* Green (Rind) */
            
            --text: #2F4F2F;
            --bg: #FAFFFA;
            --ai: #27ae60;
        }
        
        body { font-family: 'Quicksand', sans-serif; background: var(--bg); color: var(--text); padding: 15px; max-width: 700px; margin: 0 auto; line-height: 1.6; transition: background 0.3s, color 0.3s; padding-bottom: 80px; /* Space for batch bar */ }
        .container { background: white; padding: 25px; border-radius: 30px; box-shadow: 0 15px 50px rgba(0, 0, 0, 0.05); border: 1px solid var(--color2); }
        .box { background: var(--color3); padding: 15px; border-radius: 20px; margin-bottom: 20px; border: 1px solid var(--color2); transition: background 0.3s, border-color 0.3s; }
        
        .input-group { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        input { flex: 1; padding: 12px 18px; border: 2px solid var(--color2); border-radius: 15px; outline: none; transition: 0.3s; font-family: 'Quicksand', sans-serif; font-size: 0.95rem; min-width: 100px; }
        input:focus { border-color: var(--color1); background: #fff; }

        .dashboard { background: linear-gradient(135deg, var(--color1), var(--color6)); color: white; padding: 25px; border-radius: 25px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden; transition: background 0.3s; }
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 15px; }
        .stat-item { background: rgba(255,255,255,0.25); padding: 12px; border-radius: 18px; text-align: center; backdrop-filter: blur(5px); }
        .stat-val { display: block; font-size: 1.3rem; font-weight: 700; }
        .stat-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; opacity: 0.9; }
        
        /* New Attendance Section in Dashboard */
        .attendance-stats {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255,255,255,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .warning-alert { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 10px 15px; border-radius: 15px; margin-bottom: 20px; font-size: 0.9rem; display: flex; align-items: center; justify-content: space-between; }
        .warning-btn { background: #856404; color: white; border: none; padding: 5px 12px; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 0.8rem; }

        .mode-selector { display: flex; gap: 10px; margin-bottom: 25px; overflow-x: auto; padding-bottom: 8px; scrollbar-width: none; }
        .mode-selector::-webkit-scrollbar { display: none; }
        .mode-btn { flex: 1; min-width: 100px; padding: 14px 12px; border: none; border-radius: 18px; font-weight: 700; cursor: pointer; background: white; color: var(--color1); transition: 0.3s; border: 2px solid var(--color3); white-space: nowrap; font-family: 'Quicksand'; font-size: 0.85rem; }
        .mode-btn.active { background: var(--color1); color: white; border-color: var(--color1); box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); }

        .quiz-card { background: white; padding: 30px 20px; border-radius: 25px; border: 2px solid var(--color3); margin-bottom: 20px; text-align: center; min-height: 150px; display: flex; flex-direction: column; justify-content: center; transition: border-color 0.3s; }
        .quiz-q { font-size: 2.5rem; font-weight: 700; color: var(--text); margin-bottom: 10px; }
        .quiz-hint { color: #888; font-size: 0.9rem; margin-bottom: 15px; }

        .option-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .option-btn { background: white; border: 2px solid #f0f0f0; padding: 15px; border-radius: 15px; text-align: left; font-weight: 600; cursor: pointer; transition: 0.2s; font-family: 'Quicksand'; display: flex; align-items: center; color: var(--text); }
        .option-btn:hover { border-color: var(--color2); background: var(--color5); }
        .option-btn.correct { background: #eafaf1; border-color: var(--success); color: var(--success); }
        .option-btn.wrong { background: #fdeded; border-color: var(--danger); color: var(--danger); }
        .option-btn.disabled { pointer-events: none; opacity: 0.8; }
        .opt-prefix { width: 30px; height: 30px; background: var(--color3); border-radius: 8px; display: grid; place-items: center; margin-right: 12px; font-weight: 700; color: var(--color1); }

        .ai-expansion { margin-top: 20px; text-align: left; animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .expansion-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; }
        .expansion-item { background: #fffcfc; padding: 12px; border-radius: 15px; border-left: 5px solid var(--ai); border-bottom: 1px solid #eee; box-shadow: 0 4px 10px rgba(0,0,0,0.02); }
        .expansion-title { font-weight: 700; color: var(--ai); font-size: 0.75rem; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .expansion-content { font-size: 0.9rem; color: #555; font-weight: 500; }

        .btn-action { width: 100%; padding: 15px; border: none; border-radius: 18px; font-weight: 700; cursor: pointer; color: white; margin-top: 10px; font-family: 'Quicksand'; font-size: 1rem; transition: 0.3s; }
        
        .study-card { text-align: center; background: white; padding: 40px 20px; border-radius: 35px; border: 2px solid var(--color3); margin-bottom: 20px; min-height: 220px; display: flex; flex-direction: column; justify-content: center; box-shadow: 0 10px 30px rgba(0,0,0,0.02); position: relative; cursor: pointer; transition: border-color 0.3s; }
        .word-main { font-size: 3.5rem; font-weight: 700; color: var(--text); margin-bottom: 5px; }
        .word-reading { font-size: 1.4rem; color: var(--color1); font-weight: 600; opacity: 0; transition: 0.3s; min-height: 2rem; }
        .word-reading.visible { opacity: 1; }
        .word-meaning { font-size: 1.5rem; color: #636e72; border-top: 2px dashed var(--color2); padding-top: 20px; margin-top: 20px; font-weight: 600; }

        .search-container { position: relative; width: 100%; margin-bottom: 15px; }
        .search-container input { padding-left: 45px; margin-bottom: 0; width: 100%; box-sizing: border-box; }
        .search-icon { position: absolute; left: 15px; top: 14px; font-size: 1.2rem; color: var(--color1); }

        .filter-scroll-wrapper { overflow-x: auto; scrollbar-width: thin; scrollbar-color: var(--color2) transparent; margin-bottom: 20px; padding: 10px 0; -webkit-overflow-scrolling: touch; }
        .filter-scroll-wrapper::-webkit-scrollbar { height: 6px; }
        .filter-scroll-wrapper::-webkit-scrollbar-thumb { background: var(--color2); border-radius: 10px; }
        .filter-group { display: flex; gap: 12px; padding: 0 5px; min-width: max-content; }
        .lvl-tag { padding: 10px 18px; border-radius: 16px; font-size: 0.85rem; font-weight: 700; cursor: pointer; border: 2px solid transparent; transition: 0.2s; white-space: nowrap; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .lvl-tag.active { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.12); border-color: rgba(0,0,0,0.15); }

        .list-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 15px 20px; border-radius: 20px; background: white; margin-bottom: 15px; border: 1px solid var(--color2); flex-wrap: wrap; gap: 10px; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: white; border-radius: 15px; margin-bottom: 10px; border: 1px solid #f0f0f0; }

        .hidden { display: none !important; }
        .success-state { text-align: center; padding: 50px 20px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Custom Colors */
        .btn-theme { background: var(--color1) !important; color: white !important; box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1); }
        .btn-theme-soft { background: var(--color3) !important; color: var(--color1) !important; border: 1px solid var(--color2); }
        .btn-skip { background: var(--color3) !important; color: var(--color1) !important; border: 2px solid var(--color2) !important; margin-bottom: 5px; margin-top: 15px; font-weight: 700; cursor: pointer; }
        
        /* Debug Mode Button */
        .btn-test { background: var(--debug) !important; color: white !important; }
        .btn-test.active { border: 2px solid #2d3436; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
        
        .header-actions { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        
        .srs-note {
            background: #fff3cd; color: #856404; font-size: 0.8rem; padding: 8px; 
            border-radius: 10px; margin-top: 10px; text-align: center; border: 1px dashed #ffeeba;
        }
        
        .btn-next-day {
            background: #3498db !important;
            color: white !important;
            margin-top: 10px;
        }

        /* Level Badge & Quick Select Modal */
        .lvl-badge {
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 700;
            color: white;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: 0.2s;
            min-width: 50px;
        }
        .lvl-badge:active { transform: scale(0.95); }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        .level-cell {
            padding: 15px 0;
            border-radius: 12px;
            color: white;
            font-weight: bold;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }
        .level-cell:active { transform: scale(0.9); }

        /* Batch Action Bar */
        .batch-bar {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 600px;
            background: white; padding: 12px; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: flex; flex-direction: column; gap: 8px;
            border: 2px solid var(--color1); z-index: 999;
            animation: slideUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .batch-header {
            font-size: 0.9rem; font-weight: bold; color: var(--color1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .batch-levels {
            display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; scrollbar-width: none;
        }
        .batch-levels::-webkit-scrollbar { display: none; }
        .batch-btn {
            flex: 0 0 auto; padding: 8px 14px; border-radius: 12px;
            border: none; color: white; font-weight: bold; cursor: pointer; font-size: 0.8rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        /* Updated Square Rounded Checkbox */
        .item-checkbox {
            appearance: none;
            -webkit-appearance: none;
            width: 22px; height: 22px;
            /* Fix input generic width overwrite */
            min-width: 22px; 
            flex: 0 0 22px;
            
            border: 2px solid var(--color2);
            border-radius: 6px;
            cursor: pointer;
            display: grid;
            place-content: center;
            margin-right: 12px;
            transition: 0.2s;
            flex-shrink: 0;
            background: white;
        }
        .item-checkbox::before {
            content: "";
            width: 12px; height: 12px;
            transform: scale(0);
            transition: 0.2s;
            box-shadow: inset 1em 1em white;
            transform-origin: center;
            clip-path: polygon(14% 44%, 0 65%, 50% 100%, 100% 16%, 80% 0%, 43% 62%);
        }
        .item-checkbox:checked {
            background-color: var(--color1);
            border-color: var(--color1);
        }
        .item-checkbox:checked::before {
            transform: scale(1);
        }

        /* Daily Status List */
        .daily-status-item {
            display: flex; align-items: center; justify-content: space-between;
            gap: 10px; /* Th√™m kho·∫£ng c√°ch */
            padding: 10px; border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }
        .daily-status-item:last-child { border-bottom: none; }
        .status-badge {
            font-size: 0.75rem; padding: 4px 8px; border-radius: 8px; font-weight: bold;
            flex-shrink: 0; /* NgƒÉn kh√¥ng cho co l·∫°i */
            white-space: nowrap; /* Gi·ªØ tr√™n 1 d√≤ng */
        }
        .status-pending { background: #f0f0f0; color: #666; }
        .status-done { background: #eafaf1; color: var(--success); }

        @keyframes slideUp { from { transform: translate(-50%, 120%); } to { transform: translate(-50%, 0); } }

        /* Modal Basic (Reused for Level Picker) */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(5px); }
        .modal-content { background-color: #fefefe; margin: 15% auto; padding: 25px 20px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 25px; text-align: center; position: relative; animation: fadeIn 0.3s; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .close-modal { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; position: absolute; right: 15px; top: 10px; }
        .close-modal:hover { color: black; }
    </style>
</head>
<body>

<div class="container">
    <div class="box">
        <input type="password" id="api-key-input" placeholder="üîë Nh·∫≠p Gemini API Key (t√πy ch·ªçn)..." style="width:100%; box-sizing:border-box; margin-bottom: 10px;" onchange="updateApiKey()">
        
        <!-- Attendance Settings -->
        <div style="margin-bottom: 10px; display: flex; align-items: center; gap: 10px;">
            <label style="font-size: 0.9rem; font-weight: 700; color: var(--color1); white-space: nowrap;">üìÖ Ng√†y b·∫Øt ƒë·∫ßu h·ªçc:</label>
            <input type="date" id="start-date-input" onchange="updateStartDate()" style="padding: 8px 12px; font-size: 0.9rem;">
        </div>

        <div class="input-group">
            <input type="text" id="manual-word" placeholder="T·ª´ v·ª±ng (Kanji)">
            <input type="text" id="manual-reading" placeholder="C√°ch ƒë·ªçc (Hiragana)">
            <input type="text" id="manual-meaning" placeholder="√ù nghƒ©a">
            <button onclick="addManual()" style="background:var(--color1); color:white; border:none; width:50px; border-radius:15px; font-weight:bold; font-size:1.2rem; cursor:pointer;">+</button>
        </div>

        <div class="header-actions">
            <button onclick="document.getElementById('file-in').click()" class="btn-action" style="background: white; color: var(--color1); border: 2px dashed var(--color2); margin-top: 0; font-size: 0.85rem; flex: 1;">üì• Import</button>
            <button id="btn-theme" onclick="toggleTheme()" class="btn-action" style="background: var(--color6); color: white; border: none; margin-top: 0; font-size: 0.85rem; flex: 0 0 100px;">üé® Theme</button>
            <button id="btn-test-mode" onclick="toggleTestMode()" class="btn-action btn-test" style="margin-top: 0; font-size: 0.85rem; flex: 0 0 80px;">üß™ Test</button>
        </div>
        <input type="file" id="file-in" class="hidden" accept=".xlsx, .xls, .csv" onchange="handleExcel()">
    </div>

    <!-- Quick Level Picker Modal -->
    <div id="levelPickerModal" class="modal" style="z-index: 1001;">
        <div class="modal-content" style="max-width: 320px;">
            <span class="close-modal" onclick="closeLevelPicker()">&times;</span>
            <h3 style="color:var(--text); margin-top:0;">Ch·ªçn Nhanh Level</h3>
            <p style="font-size:0.85rem; color:#666; margin-bottom:10px;">Ch·∫°m ƒë·ªÉ ƒë·ªïi c·∫•p ƒë·ªô ngay l·∫≠p t·ª©c:</p>
            
            <div id="level-grid" class="level-grid">
                <!-- JS will inject buttons here -->
            </div>
            
            <button onclick="setLevel(8)" class="btn-action" style="background:var(--lv8); margin-top:15px; font-size:0.9rem;">üèÜ ƒê√£ thu·ªôc (Max)</button>
        </div>
    </div>

    <!-- Review Level Picker Modal -->
    <div id="reviewLevelModal" class="modal" style="z-index: 1001;">
        <div class="modal-content" style="max-width: 320px;">
            <span class="close-modal" onclick="closeReviewLevelModal()">&times;</span>
            <h3 style="color:var(--text); margin-top:0;">Ch·ªçn Level ƒë·ªÉ √în T·∫≠p</h3>
            <p style="font-size:0.85rem; color:#666; margin-bottom:10px;">√în to√†n b·ªô t·ª´ trong Level ƒë√£ ch·ªçn:</p>
            
            <div id="review-level-grid" class="level-grid">
                <!-- JS will inject buttons here -->
            </div>
            
            <button onclick="startLevelReview('all')" class="btn-action" style="background:var(--color1); margin-top:15px; font-size:0.9rem;">üìö √în T·∫≠p T·∫•t C·∫£</button>
        </div>
    </div>

    <!-- Daily List Modal -->
    <div id="dailyListModal" class="modal" style="z-index: 1001;">
        <div class="modal-content" style="max-width: 500px; max-height: 70vh; display: flex; flex-direction: column;">
            <span class="close-modal" onclick="closeDailyListModal()">&times;</span>
            <h3 style="color:var(--text); margin-top:0;">H√¥m Nay H·ªçc G√¨?</h3>
            <div id="daily-list-content" style="overflow-y: auto; flex: 1; text-align: left; margin-top: 10px; border: 1px solid #eee; border-radius: 15px; padding: 10px;">
                <!-- JS Inject -->
            </div>
        </div>
    </div>

    <!-- Batch Action Bar -->
    <div id="batch-action-bar" class="batch-bar hidden">
        <div class="batch-header">
            <span>ƒê√£ ch·ªçn <span id="selected-count" style="color:var(--lv1)">0</span> t·ª´</span>
            <span style="font-size:0.8rem; color:#888;">Chuy·ªÉn nhanh sang:</span>
        </div>
        <div class="batch-levels" id="batch-levels-container">
            <!-- JS injects level buttons -->
        </div>
    </div>

    <!-- ... (Gi·ªØ nguy√™n c√°c ph·∫ßn HTML kh√°c) ... -->
    <div id="daily-warning" class="warning-alert hidden">
        <span>‚ö†Ô∏è B·∫°n ch∆∞a ho√†n th√†nh t·ª´ h√¥m nay!</span>
        <button class="warning-btn" onclick="startMode('daily')">H·ªçc Ngay</button>
    </div>

    <div class="dashboard">
        <div style="display:flex; justify-content: space-between; font-size: 0.85rem; font-weight: 700; margin-bottom: 5px;">
            <span>TI·∫æN ƒê·ªò THU·ªòC L√íNG</span>
            <span id="stat-total">0 T·ª™</span>
        </div>
        <div style="background: rgba(255,255,255,0.3); height: 10px; border-radius: 10px; overflow: hidden; margin-bottom: 15px;">
            <div id="progress-bar" style="width: 0%; background: white; height: 100%; transition: 0.5s;"></div>
        </div>
        <div class="stats-grid">
            <div class="stat-item"><span class="stat-val" id="stat-new">0</span><span style="font-size:0.7rem">M·ªõi/Sai</span></div>
            <div class="stat-item"><span class="stat-val" id="stat-mid">0</span><span style="font-size:0.7rem">ƒêang h·ªçc</span></div>
            <div class="stat-item"><span class="stat-val" id="stat-high">0</span><span style="font-size:0.7rem">ƒê√£ thu·ªôc</span></div>
        </div>
        
        <!-- Attendance Stat -->
        <div class="attendance-stats">
            <div>üöÄ ƒê√£ h·ªçc: <span id="stat-studied-days">0</span> ng√†y</div>
            <div style="color: #ffcccc;">üí§ B·ªè l·ª°: <span id="stat-missed-days">0</span> ng√†y</div>
        </div>
    </div>

    <div class="mode-selector">
        <button class="mode-btn active" id="btn-daily" onclick="startMode('daily')">üî• √îN L·ªò TR√åNH</button>
        <button class="mode-btn" id="btn-list" onclick="startMode('list')">üìö DANH S√ÅCH</button>
        <button class="mode-btn" id="btn-srs" onclick="startMode('srs')">√îN T·∫¨P SRS</button>
        <button class="mode-btn" id="btn-level-review" onclick="openReviewLevelModal()">√îN T·∫¨P LEVEL</button>
    </div>

    <!-- View Tr·∫Øc nghi·ªám -->
    <div id="view-quiz">
        <div id="quiz-content">
            <div class="quiz-card">
                <div id="quiz-meta" style="font-size:0.85rem; color:var(--color1); font-weight:bold; margin-bottom:10px;">C√ÇU H·ªéI --/--</div>
                <div id="quiz-q" class="quiz-q">---</div>
                <div id="quiz-hint" class="quiz-hint">---</div>
            </div>
            
            <div style="text-align: center; margin-bottom: 15px;">
                <button onclick="openDailyListModal()" id="btn-view-daily-list" class="hidden" style="font-size: 0.8rem; background: transparent; border: 1px solid var(--color1); color: var(--color1); padding: 5px 12px; border-radius: 12px; cursor: pointer; font-family: 'Quicksand'; font-weight: 600;">üìã Danh s√°ch h√¥m nay</button>
            </div>

            <div id="options" class="option-grid"></div>
            
            <!-- N√∫t Skip ƒë∆∞·ª£c chuy·ªÉn ra ngo√†i ƒë·ªÉ hi·ªÉn th·ªã tr∆∞·ªõc khi tr·∫£ l·ªùi -->
            <div id="btn-skip-container">
                <button id="btn-skip-quiz" class="btn-action btn-skip" onclick="skipCurrentQuiz()">‚è© B·ªè qua (H·ªçc sau)</button>
            </div>

            <div id="quiz-explanation" class="hidden ai-expansion">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 20px; border: 1px solid #eee; margin-top: 15px;">
                    <div style="font-size: 1.6rem; font-weight: 700; color: var(--color1); margin-bottom: 5px;" id="expl-word"></div>
                    <div style="font-size: 1rem; color: #555; font-weight: 600;" id="expl-reading"></div>
                    <div style="font-size: 1.1rem; color: #333; margin-top: 8px; font-weight: 600; border-top: 1px solid #ddd; padding-top: 8px;" id="expl-meaning"></div>
                    <div id="expl-extra"></div>
                </div>
            </div>
            
            <!-- Note Logic SRS -->
            <div id="srs-logic-note" class="hidden srs-note">
                <!-- N·ªôi dung ƒë∆∞·ª£c JS render -->
            </div>

            <div id="quiz-next-container" class="hidden">
                <button class="btn-action btn-theme" onclick="renderNextQuiz()">Ti·∫øp theo ‚ùØ</button>
            </div>
        </div>
        
        <!-- State Empty / Finished -->
        <div id="quiz-empty" class="hidden success-state">
            <div style="font-size: 4rem;">üéâ</div>
            <h2 style="color: var(--success); font-weight: 700;">Tuy·ªát v·ªùi!</h2>
            <p style="color:#666">B·∫°n ƒë√£ ho√†n th√†nh h·∫øt b√†i √¥n t·∫≠p hi·ªán t·∫°i.</p>
            <button class="btn-action btn-theme" onclick="startMode('list')">V·ªÅ danh s√°ch</button>
        </div>

        <div id="quiz-finished" class="hidden success-state">
            <div style="font-size: 4rem;">üî•</div>
            <h2 id="finish-title" style="color: var(--success); font-weight: 700;">Ho√†n th√†nh l·ªô tr√¨nh!</h2>
            <p id="finish-msg" style="color:#666">ƒê√£ h·ªçc xong b√†i c·ªßa ng√†y h√¥m nay.</p>
            <div style="margin-bottom: 20px;">
                <button onclick="openDailyListModal()" style="font-size: 0.9rem; background: #fff; border: 2px solid var(--color1); color: var(--color1); padding: 8px 15px; border-radius: 12px; cursor: pointer; font-family: 'Quicksand'; font-weight: 700;">üìã Xem l·∫°i danh s√°ch</button>
            </div>
            <button class="btn-action btn-theme" onclick="startMode('list')">Quay l·∫°i danh s√°ch</button>
            <!-- Button Force Next Day -->
            <button id="btn-force-next-day" class="btn-action btn-next-day hidden" onclick="advanceNextDay()">üìÖ H·ªçc tr∆∞·ªõc ng√†y mai</button>
        </div>
    </div>

    <!-- View Danh s√°ch -->
    <div id="view-list" class="hidden">
        <div class="search-container">
            <span class="search-icon">üîç</span>
            <input type="text" id="search-input" placeholder="T√¨m ki·∫øm t·ª´ v·ª±ng, √Ω nghƒ©a..." oninput="renderList()">
        </div>
        
        <div class="filter-scroll-wrapper">
            <div id="level-filter-btns" class="filter-group"></div>
        </div>

        <div class="list-header" onclick="toggleList()">
            <h3 style="margin:0; font-size:1.1rem; color:var(--color1); font-weight:700;">D·ªÆ LI·ªÜU T·ª™ V·ª∞NG <span id="list-toggle-icon" style="font-size:0.8rem; margin-left:5px;">‚ñº</span></h3>
            <div style="display:flex; gap:10px; align-items:center;">
                <!-- Select All Button (Injected via JS) -->
                <div id="select-all-container"></div>
                <button onclick="clearAllData(); event.stopPropagation();" style="border:none; color:#ff7675; background:#fff0f0; padding:6px 12px; border-radius:12px; font-size:0.75rem; font-weight:700;">X√≥a h·∫øt</button>
            </div>
        </div>

        <div id="list-collapsible">
            <div id="list-items" style="max-height: 450px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- View Card (Learn Mode) -->
    <div id="view-card" class="hidden">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding: 0 10px;">
            <button onclick="changeIdx(-1)" class="btn-nav" style="border:none; background:var(--color3); color:var(--color1); width:35px; height:35px; border-radius:50%; cursor:pointer;">‚ùÆ</button>
            <span id="card-index" style="font-weight: 700; color: var(--color1);">0 / 0</span>
            <button onclick="changeIdx(1)" class="btn-nav" style="border:none; background:var(--color3); color:var(--color1); width:35px; height:35px; border-radius:50%; cursor:pointer;">‚ùØ</button>
        </div>
        
        <div class="study-card" onclick="toggleMeaning()">
            <div id="display-word" class="word-main">---</div>
            <div id="display-reading" class="word-reading">---</div>
            <div id="display-meaning" class="word-meaning hidden">---</div>
            <div id="expansion-card" class="ai-expansion hidden"></div>
        </div>

        <div id="ctrl-learn" class="hidden">
            <button class="btn-action btn-theme" onclick="markAsLearned()">‚úÖ ƒê√£ thu·ªôc t·ª´ n√†y</button>
        </div>
        
        <button class="btn-action" style="background: var(--ai); box-shadow: 0 6px 15px rgba(142, 68, 173, 0.3);" id="ai-btn" onclick="askGemini()">‚ú® Gi·∫£i th√≠ch c√πng AI</button>
        <div id="ai-loading" class="hidden" style="text-align:center; padding:15px; color:var(--ai); font-weight:700;">ƒêang k·∫øt n·ªëi AI...</div>
        <div id="ai-response" class="ai-box hidden" style="background:#f8f9fa; padding:15px; border-radius:15px; border-left:5px solid var(--ai); margin-top:10px; font-size:0.95rem;"></div>
    </div>
</div>

<!-- Main Script (Standard) -->
<script>
    let userApiKey = localStorage.getItem('gemini_api_key_jlpt') || "";
    
    // Core Variables (Will be loaded by loadData based on mode)
    var vocabulary = [];
    var dailyPointer = 0;
    var dailyQueue = [];
    var dailyTargetIds = []; // Stores IDs of all words assigned for today
    var lastStudyDate = "";

    // Attendance Variables
    var startDate = ""; // YYYY-MM-DD
    // studyLog removed as it is replaced by block logic, but kept in code logic clean up

    let quizQueue = [];
    let curQuizIdx = 0;
    let currentFilter = 'all';
    let isListOpen = true;
    let activeMode = 'learn';
    let isTestMode = false; // Tr·∫°ng th√°i Test Mode
    let currentQuizResult = 'pending'; // 'correct', 'wrong', 'skip', 'pending'

    // Variables for Quick Level Picker & Batch
    let editingWordId = null;
    let selectedIds = new Set();

    // Theme logic
    let currentTheme = localStorage.getItem('jlpt_theme') || 'pink';
    const THEMES = ['pink', 'blue', 'watermelon'];
    
    // Level Picker Logic
    function openLevelPicker(id) {
        editingWordId = id;
        const grid = document.getElementById('level-grid');
        grid.innerHTML = '';
        
        for(let i=1; i<=8; i++) {
            const btn = document.createElement('button');
            const color = getComputedStyle(document.documentElement).getPropertyValue(`--lv${i}`).trim();
            btn.className = 'level-cell';
            btn.style.background = color;
            btn.innerText = i;
            btn.onclick = () => setLevel(i);
            grid.appendChild(btn);
        }
        
        document.getElementById('levelPickerModal').style.display = "block";
    }

    function closeLevelPicker() {
        document.getElementById('levelPickerModal').style.display = "none";
        editingWordId = null;
    }

    function setLevel(newLevel) {
        if (editingWordId === null) return;
        window.changeWordLevel(editingWordId, newLevel);
        closeLevelPicker();
    }

    // Review Level Modal Logic
    function openReviewLevelModal() {
        const grid = document.getElementById('review-level-grid');
        grid.innerHTML = '';
        
        for(let i=1; i<=8; i++) {
            const btn = document.createElement('button');
            const color = getComputedStyle(document.documentElement).getPropertyValue(`--lv${i}`).trim();
            btn.className = 'level-cell';
            btn.style.background = color;
            btn.innerText = `Lv ${i}`;
            btn.onclick = () => startLevelReview(i);
            grid.appendChild(btn);
        }
        document.getElementById('reviewLevelModal').style.display = "block";
    }

    function closeReviewLevelModal() {
        document.getElementById('reviewLevelModal').style.display = "none";
    }

    function startLevelReview(level) {
        closeReviewLevelModal();
        let items = [];
        if (level === 'all') {
            items = [...vocabulary];
        } else {
            items = vocabulary.filter(v => v.level === parseInt(level));
        }

        if (items.length === 0) {
            alert("Kh√¥ng c√≥ t·ª´ n√†o trong Level n√†y ƒë·ªÉ √¥n t·∫≠p!");
            return;
        }

        quizQueue = items.sort(() => Math.random() - 0.5);
        
        // Switch to special mode
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-level-review').classList.add('active');
        
        activeMode = 'level_review'; // Special mode identifier
        document.getElementById('view-list').classList.add('hidden');
        document.getElementById('view-card').classList.add('hidden');
        document.getElementById('view-quiz').classList.remove('hidden');
        document.getElementById('srs-logic-note').classList.add('hidden');
        document.getElementById('btn-view-daily-list').classList.add('hidden');
        
        curQuizIdx = 0;
        currentQuizResult = 'pending';
        document.getElementById('quiz-content').classList.remove('hidden');
        document.getElementById('quiz-finished').classList.add('hidden');
        document.getElementById('quiz-empty').classList.add('hidden');
        
        renderQuizItem();
    }

    // Daily List Modal Logic
    function openDailyListModal() {
        const listDiv = document.getElementById('daily-list-content');
        listDiv.innerHTML = '';

        if (!dailyTargetIds || dailyTargetIds.length === 0) {
            listDiv.innerHTML = '<div style="color:#999; text-align:center;">Ch∆∞a c√≥ d·ªØ li·ªáu cho h√¥m nay.</div>';
        } else {
            let doneCount = 0;
            dailyTargetIds.forEach(id => {
                const item = vocabulary.find(v => v.id === id);
                if (!item) return;

                // Check status: If it's still in dailyQueue, it's pending. If not, it's done.
                // Note: dailyQueue elements are objects, so we compare ids.
                const isPending = dailyQueue.some(q => q.id === id);
                const statusHtml = isPending 
                    ? `<span class="status-badge status-pending">‚ö™ Ch∆∞a h·ªçc</span>`
                    : `<span class="status-badge status-done">‚úÖ ƒê√£ xong</span>`;
                
                if(!isPending) doneCount++;

                const div = document.createElement('div');
                div.className = 'daily-status-item';
                div.innerHTML = `
                    <div style="flex: 1; min-width: 0;">
                        <strong style="font-size:1.1rem">${item.word}</strong>
                        <div style="font-size:0.9rem; color:var(--color1); font-weight:600;">${item.reading}</div>
                        <div style="font-size:0.8rem; color:#666;">${item.meaning}</div>
                    </div>
                    ${statusHtml}
                `;
                listDiv.appendChild(div);
            });
            
            // Append Summary
            const summary = document.createElement('div');
            summary.style.padding = '10px';
            summary.style.marginTop = '10px';
            summary.style.background = '#f9f9f9';
            summary.style.borderRadius = '10px';
            summary.style.textAlign = 'center';
            summary.style.fontWeight = 'bold';
            summary.style.color = 'var(--color1)';
            summary.innerText = `Ti·∫øn ƒë·ªô: ${doneCount} / ${dailyTargetIds.length}`;
            listDiv.prepend(summary);
        }
        
        document.getElementById('dailyListModal').style.display = "block";
    }

    function closeDailyListModal() {
        document.getElementById('dailyListModal').style.display = "none";
    }

    window.onclick = function(event) {
        const pickerModal = document.getElementById('levelPickerModal');
        const reviewModal = document.getElementById('reviewLevelModal');
        const dailyModal = document.getElementById('dailyListModal');
        if (event.target == pickerModal) closeLevelPicker();
        if (event.target == reviewModal) closeReviewLevelModal();
        if (event.target == dailyModal) closeDailyListModal();
    }

    function getStorageKey(baseKey) {
        return isTestMode ? baseKey + "_test" : baseKey;
    }

    function loadData() {
        const vocabKey = getStorageKey('jlpt_vocab_v3');
        const pointerKey = getStorageKey('jlpt_daily_pointer');
        const queueKey = getStorageKey('jlpt_daily_queue');
        const idsKey = getStorageKey('jlpt_daily_target_ids');
        const dateKey = getStorageKey('jlpt_last_study_date');
        const startKey = getStorageKey('jlpt_start_date');

        // Logic ƒë·∫∑c bi·ªát cho vocab: N·∫øu v√†o test mode m√† ch∆∞a c√≥ data test, clone t·ª´ main
        let rawVocab = localStorage.getItem(vocabKey);
        
        if (isTestMode && !rawVocab) {
            // Clone data th·∫≠t sang data test l·∫ßn ƒë·∫ßu
            rawVocab = localStorage.getItem('jlpt_vocab_v3') || "[]";
            localStorage.setItem(vocabKey, rawVocab);
        }

        vocabulary = JSON.parse(rawVocab || "[]");
        dailyPointer = parseInt(localStorage.getItem(pointerKey)) || 0;
        dailyQueue = JSON.parse(localStorage.getItem(queueKey) || "[]");
        dailyTargetIds = JSON.parse(localStorage.getItem(idsKey) || "[]");
        lastStudyDate = localStorage.getItem(dateKey) || "";
        
        // Attendance Data
        startDate = localStorage.getItem(startKey) || "";

        // Set date input value
        if (startDate) {
            document.getElementById('start-date-input').value = startDate;
        }

        // Fallback: If queue exists but targets missing (old data), fill targets from queue
        if (dailyQueue.length > 0 && dailyTargetIds.length === 0) {
            dailyTargetIds = dailyQueue.map(v => v.id);
            localStorage.setItem(idsKey, JSON.stringify(dailyTargetIds));
        }
    }

    function updateApiKey() {
        userApiKey = document.getElementById('api-key-input').value.trim();
        localStorage.setItem('gemini_api_key_jlpt', userApiKey);
    }
    
    function updateStartDate() {
        startDate = document.getElementById('start-date-input').value;
        saveData(); // Save to sync across reloads
    }

    function toggleTheme() {
        const body = document.body;
        
        // Find current index
        let currentIndex = THEMES.indexOf(currentTheme);
        if (currentIndex === -1) currentIndex = 0; // Default to pink if invalid
        
        // Next theme
        currentIndex = (currentIndex + 1) % THEMES.length;
        currentTheme = THEMES[currentIndex];
        
        applyTheme(currentTheme);
        localStorage.setItem('jlpt_theme', currentTheme);
    }

    function applyTheme(themeName) {
        document.body.classList.remove('theme-blue', 'theme-watermelon');
        if (themeName === 'blue') {
            document.body.classList.add('theme-blue');
        } else if (themeName === 'watermelon') {
            document.body.classList.add('theme-watermelon');
        }
        
        // Update Meta Theme Color for Mobile Browser Bar
        let metaColor = "#F5AFAF"; // Default Pink
        if(themeName === 'blue') metaColor = "#1C4D8D";
        if(themeName === 'watermelon') metaColor = "#FFAAB8";
        document.querySelector('meta[name="theme-color"]').setAttribute("content", metaColor);
    }

    function loadTheme() {
        if (!THEMES.includes(currentTheme)) currentTheme = 'pink';
        applyTheme(currentTheme);
    }

    // Toggle Test Mode
    function toggleTestMode() {
        isTestMode = !isTestMode;
        const btn = document.getElementById('btn-test-mode');
        
        // Reload data base on new mode
        loadData();
        
        if (isTestMode) {
            btn.classList.add('active');
            btn.innerText = "‚ö° ƒêang Test";
            alert("ƒê√£ b·∫≠t Ch·∫ø ƒë·ªô Test (D·ªØ li·ªáu ri√™ng bi·ªát):\n- L·ªô tr√¨nh: 5 t·ª´/ng√†y\n- √în t·∫≠p: T√≠nh b·∫±ng Gi√¢y\n- Ti·∫øn ƒë·ªô kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn d·ªØ li·ªáu ch√≠nh.");
        } else {
            btn.classList.remove('active');
            btn.innerText = "üß™ Test";
            alert("ƒê√£ t·∫Øt Ch·∫ø ƒë·ªô Test. Quay v·ªÅ d·ªØ li·ªáu h·ªçc ch√≠nh th·ª©c.");
        }
        
        updateDashboard();
        renderList();
        // Reset view v·ªÅ m·∫∑c ƒë·ªãnh an to√†n
        startMode('list');
        updateSRSNote(); 
    }
    
    function updateSRSNote() {
        const noteEl = document.getElementById('srs-logic-note');
        if (activeMode === 'srs') {
            noteEl.classList.remove('hidden');
            if (isTestMode) {
                noteEl.innerHTML = "<strong>‚ö° LOGIC TEST (Gi√¢y):</strong> Sai=Lv1 | Lv1‚Üí0s | Lv2‚Üí10s | Lv3‚Üí60s | Lv4‚Üí300s...";
            } else {
                noteEl.innerHTML = "<strong>üïí LOGIC CHU·∫®N (Ph√∫t):</strong> Sai=Lv1 | Lv1‚Üí0p | Lv2‚Üí10p | Lv3‚Üí1h | Lv4‚Üí1ng√†y...";
            }
        } else {
            noteEl.classList.add('hidden');
        }
    }

    function isDuplicate(word) {
        return vocabulary.some(v => v.word.toLowerCase() === word.toLowerCase());
    }

    function addManual() {
        const w = document.getElementById('manual-word').value.trim();
        const r = document.getElementById('manual-reading').value.trim();
        const m = document.getElementById('manual-meaning').value.trim();
        if(!w) return;
        
        if(isDuplicate(w)) {
            alert("T·ª´ n√†y ƒë√£ t·ªìn t·∫°i trong danh s√°ch!");
            return;
        }

        vocabulary.push({ id: Date.now() + Math.random(), word: w, reading: r, meaning: m || "Ch∆∞a d·ªãch", level: 1, nextReview: 0, learned: false, extra: null });
        saveData(); renderList(); startMode('list');
        ['manual-word', 'manual-reading', 'manual-meaning'].forEach(id => document.getElementById(id).value = '');
    }

    function handleExcel() {
        const file = document.getElementById('file-in').files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            
            let addedCount = 0;
            let duplicateCount = 0;

            rows.forEach((r) => {
                const w = String(r[0] || '').trim();
                if (w) {
                    if (!isDuplicate(w)) {
                        vocabulary.push({ 
                            id: Date.now() + Math.random(), 
                            word: w, 
                            reading: String(r[1] || '').trim(), 
                            meaning: String(r[2] || '').trim(), 
                            level: 1, 
                            nextReview: 0,
                            learned: false,
                            extra: null
                        });
                        addedCount++;
                    } else {
                        duplicateCount++;
                    }
                }
            });
            saveData(); 
            renderList(); 
            alert(`X·ª≠ l√Ω xong!\n- Th√™m m·ªõi: ${addedCount} t·ª´\n- Tr√πng l·∫∑p b·ªè qua: ${duplicateCount} t·ª´`);
        };
        reader.readAsArrayBuffer(file);
    }

    function saveData() {
        localStorage.setItem(getStorageKey('jlpt_vocab_v3'), JSON.stringify(vocabulary));
        localStorage.setItem(getStorageKey('jlpt_daily_pointer'), dailyPointer);
        localStorage.setItem(getStorageKey('jlpt_daily_queue'), JSON.stringify(dailyQueue));
        localStorage.setItem(getStorageKey('jlpt_daily_target_ids'), JSON.stringify(dailyTargetIds));
        localStorage.setItem(getStorageKey('jlpt_last_study_date'), lastStudyDate);
        
        // Attendance Data
        localStorage.setItem(getStorageKey('jlpt_start_date'), startDate);

        updateDashboard();
        renderFilterTags();
    }
    // Expose saveData to window for Firebase script
    window.saveData = saveData;

    function updateDashboard() {
        const total = vocabulary.length;
        document.getElementById('stat-total').innerText = total + " T·ª™";
        const high = vocabulary.filter(v => v.level >= 6).length;
        const mid = vocabulary.filter(v => v.level > 1 && v.level < 6).length;
        const low = total - (high + mid);
        document.getElementById('stat-new').innerText = low;
        document.getElementById('stat-mid').innerText = mid;
        document.getElementById('stat-high').innerText = high;
        const p = total > 0 ? Math.round(((high + mid) / total) * 100) : 0;
        document.getElementById('progress-bar').style.width = Math.min(100, p) + '%';
        
        const target = isTestMode ? 5 : 50;
        if (dailyQueue.length > 0 && dailyQueue.length < target) {
             document.getElementById('daily-warning').classList.remove('hidden');
        } else {
             document.getElementById('daily-warning').classList.add('hidden');
        }
        
        // --- UPDATED ATTENDANCE LOGIC: 50 words/day (Block based) ---
        let completedBlocks = 0;
        const BLOCK_SIZE = 50;
        
        // Iterate vocabulary in chunks of 50
        for (let i = 0; i < vocabulary.length; i += BLOCK_SIZE) {
            const chunk = vocabulary.slice(i, i + BLOCK_SIZE);
            if (chunk.length > 0) {
                 // Requirement: "if those 50 words are learned"
                 // Check if every word in this specific chunk is learned
                 const allLearned = chunk.every(v => v.learned);
                 if (allLearned) {
                     completedBlocks++;
                 }
            }
        }
        
        document.getElementById('stat-studied-days').innerText = completedBlocks;

        // Calculate Missed Days based on Calendar vs Completed Blocks
        if (startDate) {
            const start = new Date(startDate);
            const now = new Date();
            start.setHours(0,0,0,0);
            now.setHours(0,0,0,0);
            
            if (start <= now) {
                // Calculate elapsed days (including today)
                const timeDiff = now.getTime() - start.getTime();
                const calendarDays = Math.floor(timeDiff / (1000 * 3600 * 24)) + 1;
                
                // Missed = Expected (Calendar) - Actual (Blocks)
                const missed = Math.max(0, calendarDays - completedBlocks);
                document.getElementById('stat-missed-days').innerText = missed;
            } else {
                 // Future date selected
                 document.getElementById('stat-missed-days').innerText = "0";
            }
        } else {
            // No date selected
            document.getElementById('stat-missed-days').innerText = "0 (Ch∆∞a ch·ªçn ng√†y b·∫Øt ƒë·∫ßu)";
        }
    }
    window.updateDashboard = updateDashboard;

    // New Function: Change Word Level (Single)
    function changeWordLevel(id, newLevel) {
        newLevel = parseInt(newLevel);
        const idx = vocabulary.findIndex(v => v.id === id);
        if (idx !== -1) {
            vocabulary[idx].level = newLevel;
            vocabulary[idx].learned = true; // Mark as learned immediately
            setNextReview(vocabulary[idx]); // Calculate new review time based on level
            
            // Remove from dailyQueue if present (because it's now learned manually)
            const inDaily = dailyQueue.findIndex(q => q.id === id);
            if (inDaily !== -1) {
                dailyQueue.splice(inDaily, 1);
            }
            
            saveData();
            renderList();
            updateDashboard();
        }
    }
    window.changeWordLevel = changeWordLevel;

    // --- BATCH ACTION LOGIC ---
    function toggleSelect(id) {
        if (selectedIds.has(id)) selectedIds.delete(id);
        else selectedIds.add(id);
        renderBatchBar();
    }
    window.toggleSelect = toggleSelect;

    function renderBatchBar() {
        const bar = document.getElementById('batch-action-bar');
        const container = document.getElementById('batch-levels-container');
        if (selectedIds.size > 0) {
            bar.classList.remove('hidden');
            document.getElementById('selected-count').innerText = selectedIds.size;
            
            // Render level buttons
            let html = '';
            for(let i=1; i<=8; i++) {
                 const color = getComputedStyle(document.documentElement).getPropertyValue(`--lv${i}`).trim();
                 html += `<button class="batch-btn" style="background:${color}" onclick="batchChangeLevel(${i})">Lv${i}</button>`;
            }
            html += `<button class="batch-btn" style="background:var(--lv8); border:1px solid white;" onclick="batchChangeLevel(8)">Max</button>`;
            container.innerHTML = html;
        } else {
            bar.classList.add('hidden');
        }
    }

    function batchChangeLevel(newLevel) {
        if(selectedIds.size === 0) return;
        if(!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën chuy·ªÉn ${selectedIds.size} t·ª´ sang Level ${newLevel}?`)) return;

        let count = 0;
        vocabulary.forEach(v => {
            if(selectedIds.has(v.id)) {
                v.level = newLevel;
                v.learned = true;
                setNextReview(v);
                count++;
            }
        });

        // Clear selections
        selectedIds.clear();
        saveData();
        renderList();
        renderBatchBar();
        updateDashboard();
        // alert(`ƒê√£ c·∫≠p nh·∫≠t ${count} t·ª´!`);
    }
    window.batchChangeLevel = batchChangeLevel;

    function toggleSelectAll() {
        const items = getFilteredItems();
        if(selectedIds.size === items.length && items.length > 0) {
            // Deselect all
            selectedIds.clear();
        } else {
            // Select all visible
            items.forEach(v => selectedIds.add(v.id));
        }
        renderList(); // Re-render to show checkboxes status
        renderBatchBar();
    }
    window.toggleSelectAll = toggleSelectAll;

    function getFilteredItems() {
        const query = document.getElementById('search-input').value.toLowerCase();
        return vocabulary.filter(v => {
            const mFilter = currentFilter === 'all' || v.level == currentFilter;
            const mSearch = v.word.toLowerCase().includes(query) || v.reading.toLowerCase().includes(query) || v.meaning.toLowerCase().includes(query);
            return mFilter && mSearch;
        });
    }

    function startMode(mode) {
        activeMode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        const btn = document.getElementById(`btn-${mode}`);
        if(btn) btn.classList.add('active');
        
        document.getElementById('view-quiz').classList.add('hidden');
        document.getElementById('view-list').classList.add('hidden');
        document.getElementById('view-card').classList.add('hidden');
        document.getElementById('srs-logic-note').classList.add('hidden');
        document.getElementById('btn-view-daily-list').classList.add('hidden');

        if (mode === 'daily') {
            document.getElementById('view-quiz').classList.remove('hidden');
            document.getElementById('btn-view-daily-list').classList.remove('hidden');
            setupDailyQuiz();
        } else if (mode === 'list') {
            document.getElementById('view-list').classList.remove('hidden');
            renderList();
        } else if (mode === 'srs') {
            document.getElementById('view-quiz').classList.remove('hidden');
            setupSRSQuiz();
        } else if (mode === 'quiz') {
            document.getElementById('view-quiz').classList.remove('hidden');
            setupRandomQuiz();
        } else if (mode === 'learn') {
            document.getElementById('view-card').classList.remove('hidden');
            setupLearnMode();
        } else if (mode === 'level_review') { // Keep current view if refreshing
             document.getElementById('view-quiz').classList.remove('hidden');
        }
    }

    // LOGIC √îN L·ªò TR√åNH CHU·∫®N
    function setupDailyQuiz() {
        if (vocabulary.length === 0) return alert("Vui l√≤ng th√™m d·ªØ li·ªáu!");
        
        // Clean queue: remove any words that are already learned (just in case)
        dailyQueue = dailyQueue.filter(item => {
             const realWord = vocabulary.find(v => v.id === item.id);
             return realWord && !realWord.learned;
        });
        saveData(); // Save cleaned queue
        
        const todayStr = new Date().toISOString().split('T')[0]; 
        
        // Load l·∫°i lastStudyDate t·ª´ bi·∫øn global ƒë√£ sync
        if (dailyQueue.length === 0) {
            if (!lastStudyDate || todayStr !== lastStudyDate) {
                generateDailyBatch();
            } else {
                showFinished("Daily");
            }
        } else {
            quizQueue = dailyQueue;
            curQuizIdx = 0;
            currentQuizResult = 'pending';
            document.getElementById('quiz-content').classList.remove('hidden');
            document.getElementById('quiz-finished').classList.add('hidden');
            document.getElementById('quiz-empty').classList.add('hidden');
            renderQuizItem();
        }
    }

    function generateDailyBatch() {
        const todayStr = new Date().toISOString().split('T')[0];
        lastStudyDate = todayStr; // C·∫≠p nh·∫≠t bi·∫øn global
        
        const dailyLimit = isTestMode ? 5 : 50;
        
        // Updated Logic: Skip learned words when generating batch
        let count = 0;
        let batch = [];
        let candidatePointer = dailyPointer;
        
        // Loop through vocabulary starting from current pointer
        // Add only unlearned words until limit is reached or end of vocab
        while (count < dailyLimit && candidatePointer < vocabulary.length) {
            if (!vocabulary[candidatePointer].learned) {
                batch.push(vocabulary[candidatePointer]);
                count++;
            }
            candidatePointer++;
        }
        
        if (batch.length === 0 && vocabulary.length > 0) {
             // If we reached the end and found nothing, check if we need to reset or if user really finished everything
            if(candidatePointer >= vocabulary.length && count === 0) {
                 if(confirm("B·∫°n ƒë√£ h·ªçc h·∫øt t·ª´ v·ª±ng! B·∫°n c√≥ mu·ªën quay l·∫°i t·ª´ ƒë·∫ßu kh√¥ng?")) {
                    dailyPointer = 0;
                    saveData();
                    generateDailyBatch(); // recursive call to try again from start
                    return;
                } else {
                    return startMode('list');
                }
            }
        }
        
        // Update global pointer to where we stopped scanning
        dailyPointer = candidatePointer;
        
        // C·∫¨P NH·∫¨T: Quiz th√¨ Random, List th√¨ c·ªë ƒë·ªãnh
        // Capture IDs for the "Today's List" feature (BEFORE shuffle to keep order)
        dailyTargetIds = batch.map(v => v.id);
        
        // Shuffle for Quiz
        dailyQueue = [...batch].sort(() => Math.random() - 0.5);
        
        saveData();
        
        quizQueue = dailyQueue; 
        curQuizIdx = 0;
        currentQuizResult = 'pending';
        
        document.getElementById('quiz-content').classList.remove('hidden');
        document.getElementById('quiz-finished').classList.add('hidden');
        document.getElementById('quiz-empty').classList.add('hidden');
        
        renderQuizItem();
    }
    
    function advanceNextDay() {
        const dailyLimit = isTestMode ? 5 : 50;
        if(confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën chuy·ªÉn sang ng√†y ti·∫øp theo kh√¥ng?\nH√†nh ƒë·ªông n√†y s·∫Ω t·∫£i ${dailyLimit} t·ª´ m·ªõi.`)) {
            generateDailyBatch();
        }
    }

    function setupRandomQuiz() {
         if (vocabulary.length === 0) return alert("Vui l√≤ng th√™m d·ªØ li·ªáu!");
         quizQueue = [...vocabulary].sort(() => Math.random() - 0.5).slice(0, 10);
         curQuizIdx = 0;
         currentQuizResult = 'pending';
         document.getElementById('quiz-content').classList.remove('hidden');
         document.getElementById('quiz-finished').classList.add('hidden');
         document.getElementById('quiz-empty').classList.add('hidden');
         renderQuizItem();
    }

    function setupSRSQuiz() {
        const now = Date.now();
        // REMOVED SLICE LIMIT HERE
        quizQueue = vocabulary.filter(v => v.learned === true && v.nextReview <= now)
                              .sort(() => Math.random() - 0.5);
        curQuizIdx = 0;
        currentQuizResult = 'pending';
        
        document.getElementById('quiz-content').classList.remove('hidden');
        document.getElementById('quiz-finished').classList.add('hidden');
        updateSRSNote();

        if (quizQueue.length === 0) {
            document.getElementById('quiz-content').classList.add('hidden');
            document.getElementById('quiz-empty').classList.remove('hidden');
        } else {
            document.getElementById('quiz-empty').classList.add('hidden');
            renderQuizItem();
        }
    }

    function setupLearnMode() {
        quizQueue = vocabulary.filter(v => !v.learned);
        if (quizQueue.length === 0) {
            alert("ƒê√£ h·ªçc h·∫øt t·ª´ m·ªõi!");
            startMode('srs');
            return;
        }
        curQuizIdx = 0;
        document.getElementById('ctrl-learn').classList.remove('hidden');
        renderCard();
    }

    function renderQuizItem() {
        const item = quizQueue[curQuizIdx];
        if (!item) return;

        const optionsDiv = document.getElementById('options');
        const nextBtnCont = document.getElementById('quiz-next-container');
        const skipBtnCont = document.getElementById('btn-skip-container');
        const skipBtn = document.getElementById('btn-skip-quiz');
        const explanation = document.getElementById('quiz-explanation');
        
        optionsDiv.innerHTML = '';
        nextBtnCont.classList.add('hidden');
        skipBtnCont.classList.remove('hidden'); 
        explanation.classList.add('hidden');
        
        if (activeMode === 'daily') {
            skipBtn.innerText = "‚è© B·ªè qua (H·ªçc sau)";
        } else if (activeMode === 'srs') {
            skipBtn.innerText = "‚è© B·ªè qua (H·∫° xu·ªëng Level 1)";
        } else if (activeMode === 'level_review') {
             skipBtn.innerText = "‚è© B·ªè qua c√¢u n√†y";
        } else {
            skipBtnCont.classList.add('hidden');
        }

        if (activeMode === 'daily') {
             document.getElementById('quiz-meta').innerText = `C√íN L·∫†I: ${dailyQueue.length} T·ª™`;
        } else {
             document.getElementById('quiz-meta').innerText = `C√ÇU H·ªéI ${curQuizIdx + 1}/${quizQueue.length}`;
        }

        const type = Math.random() > 0.5 ? 0 : 1;
        if (type === 0) {
            document.getElementById('quiz-q').innerText = item.word;
            document.getElementById('quiz-hint').innerText = "Ch·ªçn c√°ch ƒë·ªçc ƒë√∫ng:";
            generateDistractors(item, 'reading').forEach((opt, i) => createOptionBtn(opt, item.reading, i));
        } else {
            document.getElementById('quiz-q').innerText = item.reading || item.meaning;
            document.getElementById('quiz-hint').innerText = "Ch·ªçn t·ª´ v·ª±ng ƒë√∫ng:";
            generateDistractors(item, 'word').forEach((opt, i) => createOptionBtn(opt, item.word, i));
        }
    }

    function generateDistractors(correctItem, field) {
        let correctValue = correctItem[field];
        let pool = vocabulary.filter(v => v.id !== correctItem.id).sort(() => Math.random() - 0.5);
        let distractors = [correctValue];
        for (let i = 0; i < 3; i++) {
            distractors.push(pool[i] ? pool[i][field] : "---");
        }
        return distractors.sort(() => Math.random() - 0.5);
    }

    function createOptionBtn(text, correctValue, index) {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.innerHTML = `<span class="opt-prefix">${String.fromCharCode(65 + index)}</span> <span>${text}</span>`;
        btn.onclick = () => checkAnswer(text === correctValue, btn, correctValue);
        document.getElementById('options').appendChild(btn);
    }

    function checkAnswer(isCorrect, btn, correctValue) {
        document.querySelectorAll('.option-btn').forEach(b => b.classList.add('disabled'));
        const item = quizQueue[curQuizIdx];
        const mainIdx = vocabulary.findIndex(v => v.id === item.id);

        if (isCorrect) {
            btn.classList.add('correct');
            currentQuizResult = 'correct';
            
            // Logic c·∫≠p nh·∫≠t ƒëi·ªÉm ch·ªâ khi ƒë√∫ng
            if (mainIdx !== -1) {
                vocabulary[mainIdx].level = Math.min(8, vocabulary[mainIdx].level + 1);
                setNextReview(vocabulary[mainIdx]);
            }
        } else {
            btn.classList.add('wrong');
            currentQuizResult = 'wrong';
            
            document.querySelectorAll('.option-btn').forEach(b => {
                if (b.innerText.includes(correctValue)) b.classList.add('correct');
            });
            if (mainIdx !== -1) {
                vocabulary[mainIdx].level = 1; 
                vocabulary[mainIdx].nextReview = Date.now(); 
            }
        }
        
        saveData(); 
        showQuizDetail(item);
        
        document.getElementById('btn-skip-container').classList.add('hidden');
        document.getElementById('quiz-next-container').classList.remove('hidden');
    }

    function skipCurrentQuiz() {
        const item = quizQueue[curQuizIdx];
        const mainIdx = vocabulary.findIndex(v => v.id === item.id);
        currentQuizResult = 'skip';

        // 1. UI: Disable options & Highlight correct answer
        document.querySelectorAll('.option-btn').forEach(b => {
            b.classList.add('disabled');
            // Check content to find correct answer
            // Note: Option format is "A [Text]"
            if (b.innerText.includes(item.reading) || b.innerText.includes(item.word)) {
                b.classList.add('correct');
            }
        });

        // 2. Data Logic (Apply Penalty immediately if needed, except Queue movement)
        if (activeMode === 'srs') {
            if (mainIdx !== -1) {
                vocabulary[mainIdx].level = 1;
                vocabulary[mainIdx].nextReview = Date.now();
                saveData();
            }
        }
        // Daily: Queue movement happens in renderNextQuiz
        // Level Review: No penalty

        // 3. Show Explanation & Switch Buttons
        showQuizDetail(item);
        document.getElementById('btn-skip-container').classList.add('hidden');
        document.getElementById('quiz-next-container').classList.remove('hidden');
    }

    function setNextReview(item) {
        const intervals = [0, 10, 60, 300, 1440, 4320, 10080, 43200, 129600]; 
        const intervalValue = intervals[item.level - 1]; 
        const multiplier = isTestMode ? 1000 : 60000;
        item.nextReview = Date.now() + (intervalValue * multiplier);
        item.learned = true;
    }

    function showQuizDetail(item) {
        document.getElementById('expl-word').innerText = item.word;
        document.getElementById('expl-reading').innerText = item.reading;
        document.getElementById('expl-meaning').innerText = item.meaning;
        document.getElementById('expl-extra').innerHTML = item.extra ? renderExtraHtml(item.extra) : "";
        document.getElementById('quiz-explanation').classList.remove('hidden');
    }

    function renderExtraHtml(extra) {
        if(!extra) return "";
        return `
            <div class="expansion-grid">
                <div class="expansion-item"><span class="expansion-title">ƒê·ªìng nghƒ©a</span><div class="expansion-content">${extra.synonyms || "---"}</div></div>
                <div class="expansion-item"><span class="expansion-title">Tr√°i nghƒ©a</span><div class="expansion-content">${extra.antonyms || "---"}</div></div>
                <div class="expansion-item"><span class="expansion-title">Ng·ªØ ph√°p</span><div class="expansion-content">${extra.grammar || "---"}</div></div>
                <div class="expansion-item"><span class="expansion-title">V√≠ d·ª•</span><div class="expansion-content">${extra.example || "---"}</div></div>
            </div>`;
    }

    function renderNextQuiz() {
        if (activeMode === 'daily') {
            if (currentQuizResult === 'correct') {
                // Ch·ªâ x√≥a khi ƒë√∫ng
                dailyQueue.shift();
            } else {
                // N·∫øu sai HO·∫∂C Skip, ƒë·∫©y xu·ªëng cu·ªëi h√†ng ƒë·ª£i
                const wrongItem = dailyQueue.shift();
                dailyQueue.push(wrongItem);
            }
            
            saveData();
            
            if (dailyQueue.length > 0) {
                curQuizIdx = 0; // Lu√¥n l·∫•y ph·∫ßn t·ª≠ ƒë·∫ßu ti√™n
                currentQuizResult = 'pending';
                renderQuizItem();
            } else {
                showFinished("Daily");
            }
        } else {
            // C√°c mode kh√°c (SRS, Quiz, Level Review, etc)
            curQuizIdx++;
            if (curQuizIdx < quizQueue.length) {
                currentQuizResult = 'pending';
                renderQuizItem();
            } else {
                showFinished("Quiz");
            }
        }
    }

    function showFinished(type) {
        document.getElementById('quiz-content').classList.add('hidden');
        document.getElementById('quiz-finished').classList.remove('hidden');
        const target = isTestMode ? 5 : 50;
        if (type === "Daily") {
            document.getElementById('finish-title').innerText = "Ho√†n th√†nh l·ªô tr√¨nh!";
            document.getElementById('finish-msg').innerText = `Tuy·ªát v·ªùi! B·∫°n ƒë√£ ho√†n th√†nh ${target} t·ª´ c·ªßa ng√†y h√¥m nay.`;
            document.getElementById('btn-force-next-day').classList.remove('hidden');
        } else {
            document.getElementById('finish-title').innerText = "K·∫øt th√∫c b√†i √¥n!";
            document.getElementById('finish-msg').innerText = "B·∫°n ƒë√£ ho√†n th√†nh l∆∞·ª£t √¥n t·∫≠p n√†y.";
            document.getElementById('btn-force-next-day').classList.add('hidden');
        }
    }

    // --- RENDER CARD (LEARN MODE) ---
    function renderCard() {
        const item = quizQueue[curQuizIdx];
        const rEl = document.getElementById('display-reading');
        const mEl = document.getElementById('display-meaning');
        const exEl = document.getElementById('expansion-card');
        
        rEl.classList.remove('visible'); 
        mEl.classList.add('hidden');
        exEl.classList.add('hidden');
        document.getElementById('ai-response').classList.add('hidden');

        if(!item) {
            document.getElementById('display-word').innerText = "H·∫øt t·ª´!";
            return;
        }

        document.getElementById('display-word').innerText = item.word;
        rEl.innerText = item.reading;
        mEl.innerText = item.meaning;
        document.getElementById('card-index').innerText = `${curQuizIdx + 1} / ${quizQueue.length}`;
        
        if(item.extra) {
            exEl.innerHTML = renderExtraHtml(item.extra);
            exEl.classList.remove('hidden');
        }
        updateDashboard();
    }

    function toggleMeaning() { 
        document.getElementById('display-meaning').classList.toggle('hidden');
        document.getElementById('display-reading').classList.toggle('visible'); 
    }

    function changeIdx(s) { 
        if(quizQueue.length > 0) { 
            curQuizIdx = (curQuizIdx + s + quizQueue.length) % quizQueue.length; 
            renderCard(); 
        } 
    }
    
    function markAsLearned() {
        const item = quizQueue[curQuizIdx];
        const mainIdx = vocabulary.findIndex(v => v.id === item.id);
        if (mainIdx !== -1) {
            vocabulary[mainIdx].learned = true;
            vocabulary[mainIdx].level = 2; // Level 2 means 10 mins delay
            setNextReview(vocabulary[mainIdx]);
            saveData();
            quizQueue.splice(curQuizIdx, 1);
            if (curQuizIdx >= quizQueue.length) curQuizIdx = 0;
            if (quizQueue.length === 0) {
                alert("Ch√∫c m·ª´ng! B·∫°n ƒë√£ h·ªçc h·∫øt t·ª´ m·ªõi.");
                startMode('srs');
            } else {
                renderCard();
            }
        }
    }

    async function askGemini() {
        const item = quizQueue[curQuizIdx];
        const apiKey = userApiKey || "";
        if(!item) return;
        
        const loader = document.getElementById('ai-loading');
        const responseBox = document.getElementById('ai-response');
        loader.classList.remove('hidden');
        responseBox.classList.add('hidden');

        const prompt = `Ph√¢n t√≠ch t·ª´ v·ª±ng ti·∫øng Nh·∫≠t: "${item.word}".
Y√™u c·∫ßu:
1. Phi√™n √¢m Hiragana/Katakana ch√≠nh x√°c.
2. Tr·∫£ v·ªÅ ƒë√∫ng ƒë·ªãnh d·∫°ng JSON:
{
  "synonyms": "c√°c t·ª´ ƒë·ªìng nghƒ©a",
  "antonyms": "c√°c t·ª´ tr√°i nghƒ©a",
  "similar": "c√°c t·ª´ d·ªÖ nh·∫ßm l·∫´n",
  "grammar": "c·∫•u tr√∫c ng·ªØ ph√°p ƒëi k√®m n·∫øu c√≥",
  "example": "c√¢u v√≠ d·ª• ti·∫øng Nh·∫≠t (phi√™n √¢m hiragana): nghƒ©a ti·∫øng Vi·ªát"
}
L∆∞u √Ω: Ch·ªâ tr·∫£ v·ªÅ JSON, kh√¥ng k√®m l·ªùi d·∫´n.`;

        try {
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await res.json();
            let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
            text = text.replace(/```json/g, '').replace(/```/g, '').trim();
            const extraData = JSON.parse(text);
            
            const idx = vocabulary.findIndex(v => v.id === item.id);
            if(idx !== -1) {
                vocabulary[idx].extra = extraData;
                saveData();
                renderCard(); 
            }
            responseBox.innerHTML = `<strong>üí° V√≠ d·ª•:</strong><br>${extraData.example}`;
            responseBox.classList.remove('hidden');

        } catch (e) { alert("L·ªói k·∫øt n·ªëi AI."); } 
        finally { loader.classList.add('hidden'); }
    }

    // --- LIST & FILTER ---
    function renderFilterTags() {
        const container = document.getElementById('level-filter-btns');
        const levels = [1, 2, 3, 4, 5, 6, 7, 8];
        let html = `<span class="lvl-tag ${currentFilter === 'all' ? 'active' : ''}" style="background:#f0f0f0; color:#444;" onclick="setFilter('all')">T·∫•t c·∫£ (${vocabulary.length})</span>`;
        levels.forEach(lvl => {
            const count = vocabulary.filter(v => v.level === lvl).length;
            const color = getComputedStyle(document.documentElement).getPropertyValue(`--lv${lvl}`).trim();
            html += `<span class="lvl-tag ${currentFilter == lvl ? 'active' : ''}" style="background:${color}; color:#fff;" onclick="setFilter(${lvl})">Level ${lvl} (${count})</span>`;
        });
        container.innerHTML = html;
        
        // Render/Clear "Select All" button in header based on filter
        const saContainer = document.getElementById('select-all-container');
        if (currentFilter !== 'all') {
            const items = getFilteredItems();
            const allSelected = items.length > 0 && items.every(v => selectedIds.has(v.id));
            saContainer.innerHTML = `<button onclick="toggleSelectAll()" style="border:1px solid #ddd; background:${allSelected ? 'var(--color1)' : 'white'}; color:${allSelected ? 'white' : '#666'}; padding:6px 12px; border-radius:12px; font-size:0.75rem; font-weight:700;">${allSelected ? 'B·ªè ch·ªçn' : 'Ch·ªçn t·∫•t c·∫£'}</button>`;
        } else {
            saContainer.innerHTML = '';
        }
    }

    function setFilter(lvl) {
        currentFilter = lvl;
        selectedIds.clear(); // Clear selection when changing filter
        renderBatchBar();
        renderFilterTags();
        renderList();
    }

    function renderList() {
        const items = getFilteredItems();
        const listDiv = document.getElementById('list-items');
        listDiv.innerHTML = items.length === 0 ? '<div style="text-align:center; padding:20px; color:#999;">Kh√¥ng c√≥ d·ªØ li·ªáu.</div>' : '';
        
        items.forEach(v => {
            const div = document.createElement('div');
            div.className = 'list-item';
            const lvColor = getComputedStyle(document.documentElement).getPropertyValue(`--lv${v.level}`).trim();
            
            // Timer HTML
            let timerHtml = '';
            if (v.level >= 2) {
                timerHtml = `<div class="review-timer" data-next="${v.nextReview}" style="font-size:0.75rem; color:#888; margin-top:4px; font-weight:600; text-align:right;">‚è≥ ...</div>`;
            }

            const isSelected = selectedIds.has(v.id);

            div.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <input type="checkbox" class="item-checkbox" ${isSelected ? 'checked' : ''} onchange="toggleSelect(${v.id})">
                    <div>
                        <strong>${v.word}</strong> <small style="color:var(--color1)">„Äê${v.reading}„Äë</small>
                        <div style="font-size:0.85rem; color:#666;">${v.meaning}</div>
                    </div>
                </div>
                <div style="display:flex; flex-direction:column; align-items:flex-end; gap:5px;">
                    <div style="display:flex; align-items:center; gap:8px;">
                        <button class="lvl-badge" style="background:${lvColor};" onclick="openLevelPicker(${v.id})">Lv ${v.level}</button>
                        <button onclick="deleteWord(${v.id})" style="border:none; background:#fff0f0; color:#ff7675; width:30px; height:30px; border-radius:10px; cursor:pointer;">üóëÔ∏è</button>
                    </div>
                    ${timerHtml}
                </div>`;
            listDiv.appendChild(div);
        });
        updateTimers(); 
    }
    window.renderList = renderList;

    function updateTimers() {
        const now = Date.now();
        document.querySelectorAll('.review-timer').forEach(el => {
            const next = parseInt(el.getAttribute('data-next'));
            if(!next) return;
            
            const diff = next - now;

            if (diff <= 0) {
                el.innerHTML = "<span style='color:var(--success)'>ƒê·∫øn h·∫°n!</span>";
            } else {
                // Format: DD HH:MM:SS
                const d = Math.floor(diff / (1000 * 60 * 60 * 24));
                const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                
                let timeStr = "";
                if (d > 0) timeStr += `${d}d `;
                if (h > 0 || d > 0) timeStr += `${h}h `;
                if (m > 0 || h > 0 || d > 0) timeStr += `${m}m `;
                timeStr += `${s}s`;
                
                el.innerText = `‚è≥ ${timeStr}`;
            }
        });
    }

    // Start interval
    setInterval(updateTimers, 1000);

    function deleteWord(id) { 
        if(confirm("X√≥a t·ª´ n√†y?")) { 
            vocabulary = vocabulary.filter(v => v.id !== id); 
            if(selectedIds.has(id)) selectedIds.delete(id);
            if(dailyPointer > vocabulary.length) dailyPointer = Math.max(0, vocabulary.length);
            saveData(); renderList(); renderBatchBar();
        }
    }
    
    function clearAllData() { 
        if(confirm("X√≥a to√†n b·ªô d·ªØ li·ªáu?")) { localStorage.clear(); location.reload(); } 
    }

    function toggleList() {
        const content = document.getElementById('list-collapsible');
        content.classList.toggle('hidden');
        document.getElementById('list-toggle-icon').innerText = content.classList.contains('hidden') ? '‚ñº' : '‚ñ≤';
    }

    window.onload = () => { 
        if (userApiKey) document.getElementById('api-key-input').value = userApiKey;
        loadTheme();
        loadData(); // Load data initially
        updateDashboard(); 
        renderFilterTags(); 
        renderList(); 
        if (vocabulary.length > 0) startMode('daily'); 
        else startMode('list'); 
    };
</script>
</body>
</html>
